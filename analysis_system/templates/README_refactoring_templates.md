# 📋 重构计划模板使用说明

本目录包含用于生成重构计划的标准化模板，支持分析工作流系统自动生成重构文档。

## 📁 模板文件

### 🎯 总体重构计划模板
**文件**: `overall_refactoring_plan_template.md`  
**用途**: 生成项目的总体重构实施计划  
**触发条件**: 第三阶段结束时，分析目的是重构时自动生成

### 📋 详细阶段计划模板  
**文件**: `detailed_stage_plan_template.md`  
**用途**: 生成每个重构阶段的详细实施计划  
**触发条件**: 总体重构计划生成后，自动生成第一阶段详细计划

## 🔄 使用流程

### 1. 自动触发条件

重构计划模板在以下情况下自动触发使用：

- **分析目标包含重构关键词**: "重构"、"架构优化"、"模块化改造"等
- **分析结果显示需要重构**: 代码复杂度高、模块耦合严重等
- **用户明确表示需要重构计划**: 在分析过程中明确提出

### 2. 生成时机

- **总体重构计划**: 在分析工作流第三阶段（步骤3.2.1）生成
- **详细阶段计划**: 总体计划生成后立即生成第一阶段详细计划
- **后续阶段计划**: 每个阶段完成后生成下一阶段计划

### 3. 模板变量说明

#### 总体重构计划模板变量

| 变量名 | 含义 | 示例值 |
|--------|------|---------|
| `{{MODULE_NAME}}` | 模块名称 | "ANC仿真模块" |
| `{{PLAN_DATE}}` | 计划制定日期 | "2025年7月15日" |
| `{{ANALYSIS_BASIS}}` | 分析依据 | "第1轮和第2轮深度分析结果" |
| `{{STAGE_COUNT}}` | 重构阶段数量 | "4" |
| `{{PRIMARY_GOAL_1-4}}` | 主要目标列表 | "将simulation.py主类从1471行降至800-1000行" |
| `{{TARGET_ARCHITECTURE}}` | 目标架构图 | 模块结构示意图 |

#### 详细阶段计划模板变量

| 变量名 | 含义 | 示例值 |
|--------|------|---------|
| `{{STAGE_NUMBER}}` | 阶段编号 | "2" |
| `{{STAGE_OBJECTIVES}}` | 阶段目标 | "环境、控制器、仿真配置模块化" |
| `{{FUNCTION_TABLE_ROWS}}` | 函数清单表格行 | 详细的函数列表数据 |
| `{{IMPLEMENTATION_STEPS}}` | 实施步骤 | 分天的详细实施计划 |
| `{{BACKUP_FILE_LIST}}` | 备份文件命令列表 | `Copy-Item "simulation.py" "$backupDir/"` |
| `{{BACKUP_FILES_ARRAY}}` | 备份文件数组 | `"simulation.py", "config_manager.py"` |

## 🧪 测试强制要求

### 阶段门控制原则

每个重构阶段**必须满足以下测试要求**才能进入下一阶段：

1. **功能测试100%通过**: 所有原有功能完全正常
2. **性能测试达标**: 性能退化控制在5%以内  
3. **集成测试通过**: 模块间协作正常
4. **回归测试通过**: 与历史版本输出一致

### 测试验证流程

```
阶段N开发完成
    ↓
自测验证
    ↓
功能验证 (100%通过)
    ↓
性能验证 (退化<5%)
    ↓  
集成验证 (模块协作正常)
    ↓
用户验证 (真实场景测试)
    ↓
通过确认 → 进入阶段N+1
    ↓
失败 → 问题修复或回滚
```

## 📊 模板输出示例

### 总体重构计划输出文档

- `overall_refactoring_plan.md` - 总体重构策略和分阶段计划
- `phase1_detailed_plan.md` - 第一阶段详细实施计划  
- `refactoring_risk_assessment.md` - 重构风险评估
- `refactoring_testing_strategy.md` - 重构测试策略

### 详细阶段计划输出文档

- 完整的函数清单表格（包含优先级和依赖关系）
- 详细的实施步骤（按天分解）
- 风险管理和应对策略
- 预期收益评估

## 🔧 定制说明

### 模板变量替换

AI系统会根据实际分析结果自动替换模板中的变量：

1. **项目特定信息**: 基于代码分析结果自动提取
2. **技术栈信息**: 根据项目依赖和框架自动识别  
3. **复杂度数据**: 基于代码指标计算自动生成
4. **重构建议**: 基于分析发现自动制定

### 模板扩展

如需扩展模板功能：

1. 在模板文件中添加新的变量占位符
2. 在分析工作流中添加对应的数据收集逻辑
3. 更新本说明文档的变量表格

## 📝 最佳实践

### 重构计划制定原则

1. **代码安全**: 任何修改前必须先进行完整备份，确保可以快速回滚
2. **风险可控**: 每个阶段都要有明确的风险评估和回滚方案
3. **功能保护**: 任何时候都不能影响系统的核心功能
4. **渐进实施**: 小步快跑，避免大规模一次性重构
5. **测试优先**: 建立完善的测试体系确保重构安全性

### 代码备份最佳实践

#### 备份策略
- **备份时机**: 每个重构阶段开始前必须执行备份
- **备份范围**: 备份所有将要修改的源文件，包括测试文件
- **备份命名**: 使用时间戳和阶段标识，便于版本管理
- **备份验证**: 备份完成后必须验证文件完整性

#### 备份目录结构
```
backups/
├── backup_stage1_20250715_143022/    # 第一阶段备份
│   ├── simulation.py                 # 备份的源文件
│   ├── config_manager.py            # 其他相关文件
│   └── backup_metadata.json         # 备份元数据
├── backup_stage2_20250718_091534/    # 第二阶段备份
│   └── ...
└── backup_metadata.json             # 全局备份历史
```

#### 备份元数据
每次备份都会生成包含以下信息的元数据文件：
- 备份时间和阶段标识
- 备份文件列表和校验信息
- Git提交哈希值
- 重构目标和预期变更说明

### 模板使用建议

1. **强制备份**: 任何重构阶段开始前必须执行代码备份，这是不可跳过的步骤
2. **保持模板格式**: 不要随意修改模板的结构和标记
3. **验证备份**: 备份完成后必须验证文件完整性和元数据记录
4. **及时更新**: 根据实际使用经验持续优化模板内容
5. **文档同步**: 模板修改后及时更新相关文档
6. **版本管理**: 对模板文件进行版本控制，跟踪变更历史

### 安全重构流程

```powershell
# 标准重构安全流程
1. 执行代码备份 (强制步骤)
2. 验证备份完整性
3. 开始阶段性修改
4. 执行测试验证
5. 确认功能正常
6. 提交代码变更
7. 更新文档记录
```

---

**模板维护**: 这些模板会根据实际使用经验持续优化和更新，确保生成的重构计划更加准确和实用。
